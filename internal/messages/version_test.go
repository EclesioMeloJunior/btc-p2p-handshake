package messages_test

import (
	"bytes"
	"net/netip"
	"testing"

	"github.com/EclesioMeloJunior/btc-handshake/internal/messages"
	"github.com/stretchr/testify/require"
)

func TestVersionMessageEncoding(t *testing.T) {
	// taken from an example at: https://en.bitcoin.it/wiki/Protocol_documentation#version
	testEncoded := []byte{
		0x62, 0xEA, 0x00, 0x00, // version number
		0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // NODE_NETWORK service
		0x11, 0xB2, 0xD0, 0x50, 0x00, 0x00, 0x00, 0x00, // Tue Dec 18 10:12:33 PST 2012
		0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, // Recv Address Info
		0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, // Sender Address Info
		0x3B, 0x2E, 0xB3, 0x5D, 0x8C, 0xE6, 0x17, 0x65, // Nonce
		0x0F, 0x2F, 0x53, 0x61, 0x74, 0x6F, 0x73, 0x68, 0x69, 0x3A, 0x30, 0x2E, 0x37, 0x2E, 0x32, 0x2F, // User Agent
		0xC0, 0x3E, 0x03, 0x00, // Last Block Seen
		0x00,
	}

	version := &messages.Version{}
	err := version.Decode(bytes.NewReader(testEncoded))
	require.NoError(t, err)

	expectedVersion := &messages.Version{
		Number:    60002,
		Services:  1,
		Timestamp: 1355854353,
		AddrRecv: messages.NetworkAddress{
			Services: 1,
			IpV6V4:   netip.MustParseAddr("0.0.0.0"),
			Port:     0000,
		},
		AddrFrom: messages.NetworkAddress{
			Services: 1,
			IpV6V4:   netip.MustParseAddr("0.0.0.0"),
			Port:     0000,
		},
		Nonce:       7284544412836900411,
		UserAgent:   "/Satoshi:0.7.2/",
		StartHeight: 212672,
		Relay:       false,
	}
	require.Equal(t, expectedVersion, version)

	encodedVersion, err := expectedVersion.Encode()
	require.NoError(t, err)

	require.Equal(t, testEncoded, encodedVersion)
}
